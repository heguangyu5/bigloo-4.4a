<!-- 95% W3C COMPLIANT, 95% CSS FREE, RAW HTML -->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=ISO-8859-1">
<title>Bigloo</title>
 <style type="text/css">
  <!--
  pre { font-family: monospace }
  tt { font-family: monospace }
  code { font-family: monospace }
  p.flushright { text-align: right }
  p.flushleft { text-align: left }
  span.sc { font-variant: small-caps }
  span.sf { font-family: sans-serif }
  span.skribetitle { font-family: sans-serif; font-weight: bolder; font-size: x-large; }
  span.refscreen { }
  span.refprint { display: none; }
  -->
 </style>
</head>

<body class="chapter" bgcolor="#ffffff">
<table width="100%" class="skribetitle" cellspacing="0" cellpadding="0"><tbody>
<tr><td align="center" bgcolor="#8381de"><div class="skribetitle"><strong><big><big><big>29. Bigloo<br/>A practical Scheme compiler (4.4a)<br/>User manual for version 4.4a<br/>November 2020 -- Bigloo Libraries</big></big></big></strong></div><center>
</center>
</td></tr></tbody></table>
<table cellpadding="3" cellspacing="0" width="100%" class="skribe-margins"><tr>
<td align="left" valign="top" class="skribe-left-margin" width="20%" bgcolor="#dedeff"><div class="skribe-left-margin">
<br/><center id='center36741'
><table width="97%" border="1" cellpadding="0" cellspacing="0" style="border-collapse: collapse;" frame="box" rules="none"><tbody>
<tr bgcolor="#8381de"><th id="tc36731" align="center" colspan="1"><font color="#ffffff"><strong id='bold36729'
>main page</strong></font></th></tr>
<tr bgcolor="#ffffff"><td id="tc36738" align="center" colspan="1"><table width="100%" border="0" style="border-collapse: collapse;" frame="void" rules="none"><tbody>
<tr><td id="tc36734" align="left" valign="top" colspan="1"><strong id='bold36733'
>top:</strong></td><td id="tc36735" align="right" valign="top" colspan="1"><a href="bigloo.html#Bigloo-A-practical-Scheme-compiler-(-4.4a-)-User-manual-for-version-4.4a-November-2020" class="inbound">Bigloo<br/>A practical Scheme compiler (4.4a)<br/>User manual for version 4.4a<br/>November 2020</a></td></tr>
</tbody></table>
</td></tr>
</tbody></table>
</center>
<br/><br/><center id='center36751'
><table width="97%" border="1" cellpadding="0" cellspacing="0" style="border-collapse: collapse;" frame="box" rules="none"><tbody>
<tr bgcolor="#8381de"><th id="tc36745" align="center" colspan="1"><font color="#ffffff"><strong id='bold36743'
>Bigloo Libraries</strong></font></th></tr>
<tr bgcolor="#ffffff"><td id="tc36748" align="center" colspan="1"><table cellspacing="1" cellpadding="1" width="100%" class="toc">
<tbody>
 <tr><td valign="top" align="left">29.1</td><td colspan="4" width="100%"><a href="bigloo-30.html#Compiling-and-linking-with-a-library">Compiling and linking with a library</a></td></tr>
 <tr><td valign="top" align="left">29.2</td><td colspan="4" width="100%"><a href="bigloo-30.html#Library-and-inline-functions">Library and inline functions</a></td></tr>
 <tr><td valign="top" align="left">29.3</td><td colspan="4" width="100%"><a href="bigloo-30.html#library-and-eval">library and eval</a></td></tr>
 <tr><td valign="top" align="left">29.4</td><td colspan="4" width="100%"><a href="bigloo-30.html#library-and-repl">library and repl</a></td></tr>
 <tr><td valign="top" align="left">29.5</td><td colspan="4" width="100%"><a href="bigloo-30.html#Building-a-library">Building a library</a></td></tr>
 <tr><td valign="top" align="left">29.6</td><td colspan="4" width="100%"><a href="bigloo-30.html#Library-and-modules">Library and modules</a></td></tr>
 <tr><td valign="top" align="left">29.7</td><td colspan="4" width="100%"><a href="bigloo-30.html#Library-and-macros">Library and macros</a></td></tr>
 <tr><td valign="top" align="left">29.8</td><td colspan="4" width="100%"><a href="bigloo-30.html#A-complete-library-example">A complete library example</a></td></tr>
</tbody>
</table>
</td></tr>
</tbody></table>
</center>
<br/><br/><center id='center36761'
><table width="97%" border="1" cellpadding="0" cellspacing="0" style="border-collapse: collapse;" frame="box" rules="none"><tbody>
<tr bgcolor="#8381de"><th id="tc36755" align="center" colspan="1"><font color="#ffffff"><strong id='bold36753'
>Chapters</strong></font></th></tr>
<tr bgcolor="#ffffff"><td id="tc36758" align="center" colspan="1"><table cellspacing="1" cellpadding="1" width="100%" class="toc">
<tbody>
 <tr><td valign="top" align="left"></td><td colspan="4" width="100%"><a href="bigloo-1.html#Acknowledgements">Acknowledgements</a></td></tr>
 <tr><td valign="top" align="left">1</td><td colspan="4" width="100%"><a href="bigloo-2.html#Table-of-contents">Table of contents</a></td></tr>
 <tr><td valign="top" align="left">2</td><td colspan="4" width="100%"><a href="bigloo-3.html#Overview-of-Bigloo">Overview of Bigloo</a></td></tr>
 <tr><td valign="top" align="left">3</td><td colspan="4" width="100%"><a href="bigloo-4.html#Modules">Modules</a></td></tr>
 <tr><td valign="top" align="left">4</td><td colspan="4" width="100%"><a href="bigloo-5.html#Core-Language">Core Language</a></td></tr>
 <tr><td valign="top" align="left">5</td><td colspan="4" width="100%"><a href="bigloo-6.html#DSSSL-support">DSSSL support</a></td></tr>
 <tr><td valign="top" align="left">6</td><td colspan="4" width="100%"><a href="bigloo-7.html#Standard-Library">Standard Library</a></td></tr>
 <tr><td valign="top" align="left">7</td><td colspan="4" width="100%"><a href="bigloo-8.html#Pattern-Matching">Pattern Matching</a></td></tr>
 <tr><td valign="top" align="left">8</td><td colspan="4" width="100%"><a href="bigloo-9.html#Fast-search">Fast search</a></td></tr>
 <tr><td valign="top" align="left">9</td><td colspan="4" width="100%"><a href="bigloo-10.html#Structures-and-Records">Structures and Records</a></td></tr>
 <tr><td valign="top" align="left">10</td><td colspan="4" width="100%"><a href="bigloo-11.html#Object-System">Object System</a></td></tr>
 <tr><td valign="top" align="left">11</td><td colspan="4" width="100%"><a href="bigloo-12.html#Regular-parsing">Regular parsing</a></td></tr>
 <tr><td valign="top" align="left">12</td><td colspan="4" width="100%"><a href="bigloo-13.html#Lalr(1)-parsing">Lalr(1) parsing</a></td></tr>
 <tr><td valign="top" align="left">13</td><td colspan="4" width="100%"><a href="bigloo-14.html#Posix-Regular-Expressions">Posix Regular Expressions</a></td></tr>
 <tr><td valign="top" align="left">14</td><td colspan="4" width="100%"><a href="bigloo-15.html#Command-Line-Parsing">Command Line Parsing</a></td></tr>
 <tr><td valign="top" align="left">15</td><td colspan="4" width="100%"><a href="bigloo-16.html#Cryptography">Cryptography</a></td></tr>
 <tr><td valign="top" align="left">16</td><td colspan="4" width="100%"><a href="bigloo-17.html#Errors-Assertions-and-Traces">Errors, Assertions, and Traces</a></td></tr>
 <tr><td valign="top" align="left">17</td><td colspan="4" width="100%"><a href="bigloo-18.html#Threads">Threads</a></td></tr>
 <tr><td valign="top" align="left">18</td><td colspan="4" width="100%"><a href="bigloo-19.html#Database">Database</a></td></tr>
 <tr><td valign="top" align="left">19</td><td colspan="4" width="100%"><a href="bigloo-20.html#Multimedia">Multimedia</a></td></tr>
 <tr><td valign="top" align="left">20</td><td colspan="4" width="100%"><a href="bigloo-21.html#Mail">Mail</a></td></tr>
 <tr><td valign="top" align="left">21</td><td colspan="4" width="100%"><a href="bigloo-22.html#Text">Text</a></td></tr>
 <tr><td valign="top" align="left">22</td><td colspan="4" width="100%"><a href="bigloo-23.html#CSV">CSV</a></td></tr>
 <tr><td valign="top" align="left">23</td><td colspan="4" width="100%"><a href="bigloo-24.html#Eval-and-code-interpretation">Eval and code interpretation</a></td></tr>
 <tr><td valign="top" align="left">24</td><td colspan="4" width="100%"><a href="bigloo-25.html#Macro-expansion">Macro expansion</a></td></tr>
 <tr><td valign="top" align="left">25</td><td colspan="4" width="100%"><a href="bigloo-26.html#Parameters">Parameters</a></td></tr>
 <tr><td valign="top" align="left">26</td><td colspan="4" width="100%"><a href="bigloo-27.html#Explicit-typing">Explicit typing</a></td></tr>
 <tr><td valign="top" align="left">27</td><td colspan="4" width="100%"><a href="bigloo-28.html#The-C-interface">The C interface</a></td></tr>
 <tr><td valign="top" align="left">28</td><td colspan="4" width="100%"><a href="bigloo-29.html#The-Java-interface">The Java interface</a></td></tr>
 <tr><td valign="top" align="left">29</td><td colspan="4" width="100%"><a href="bigloo-30.html#Bigloo-Libraries">Bigloo Libraries</a></td></tr>
 <tr><td valign="top" align="left">30</td><td colspan="4" width="100%"><a href="bigloo-31.html#Extending-the-Runtime-System">Extending the Runtime System</a></td></tr>
 <tr><td valign="top" align="left">31</td><td colspan="4" width="100%"><a href="bigloo-32.html#SRFIs">SRFIs</a></td></tr>
 <tr><td valign="top" align="left">32</td><td colspan="4" width="100%"><a href="bigloo-33.html#Compiler-description">Compiler description</a></td></tr>
 <tr><td valign="top" align="left">33</td><td colspan="4" width="100%"><a href="bigloo-34.html#Cross-Compilation">Cross Compilation</a></td></tr>
 <tr><td valign="top" align="left">34</td><td colspan="4" width="100%"><a href="bigloo-35.html#User-Extensions">User Extensions</a></td></tr>
 <tr><td valign="top" align="left">35</td><td colspan="4" width="100%"><a href="bigloo-36.html#Bigloo-Development-Environment">Bigloo Development Environment</a></td></tr>
 <tr><td valign="top" align="left">36</td><td colspan="4" width="100%"><a href="bigloo-37.html#Global-Index">Global Index</a></td></tr>
 <tr><td valign="top" align="left">37</td><td colspan="4" width="100%"><a href="bigloo-38.html#Library-Index">Library Index</a></td></tr>
 <tr><td valign="top" align="left"></td><td colspan="4" width="100%"><a href="bigloo-39.html#Bibliography">Bibliography</a></td></tr>
</tbody>
</table>
</td></tr>
</tbody></table>
</center>
</div></td>
<td align="left" valign="top" class="skribe-body"><div class="skribe-body">
<a name="Bigloo-Libraries" class="mark"></a><a name="g29242" class="mark"></a>
Bigloo libraries are collections of global bindings (global variables and
global functions). Bigloo libraries are built on the top of the host
operating system (e.g. Unix) libraries. Because Bigloo uses modules, a
library is not only a bundle of compiled codes and memory locations. A
Bigloo library is split into several files:<br/><br/><ul class="itemize" id='itemize29251'
><li>one <em id='emph29245'
>heap</em> that describes the variables and functions of the library.
</li>
<li>several host library files (safe and unsafe versions of the compilation
and also <em id='emph29247'
>eval libraries</em> that contain the code that binds the
variables and functions to the evaluator).
</li>
<li>possibly, C header files.
</li>
<li>possibly, an initialization file.
</li>
</ul>
Let's consider, for example, a library that implements the
<code id='code29252'
>format</code> Common Lisp facility. Let's suppose we name this library
<code id='code29253'
>bformat</code> and that the library number is
<code id='code29254'
>1.0</code>. Using a Unix machine, the Bigloo library will consist of
the following files:<br/><br/><ul class="itemize" id='itemize29278'
><li><code id='code29256'
>bformat.heap</code>: the heap file.
</li>
<li><code id='code29258'
>bformat.init</code>: the initialization file.
</li>
<li><code id='code29260'
>libbformat_s-1.0.a</code>, <code id='code29261'
>libbformat_s-1.0.so</code>, 
 <code id='code29262'
>libbformat_u-1.0.a</code>, <code id='code29263'
>libbformat_u-1.0.so</code>,
 <code id='code29264'
>libbformat_eu-1.0.so</code>, and <code id='code29265'
>libbformat_es-1.0.so</code>::
the Unix library files. The file names with a <code id='code29266'
>_u</code> are libraries compiled 
in <em id='emph29267'
>unsafe</em> and <em id='emph29268'
>optimized</em> mode. By convention the library using
the <code id='code29269'
>_s</code> suffix are <em id='emph29270'
>safe</em> libraries, <code id='code29271'
>_p</code> are profiling
libraries, <code id='code29272'
>_d</code> debug libraries, <code id='code29273'
>_es</code> and <code id='code29274'
>_eu</code> eval libraries.
</li>
<li><code id='code29276'
>bformat.h</code>: an include file.
</li>
</ul>
<!-- Compiling and linking with a library -->
<a name="Compiling-and-linking-with-a-library"></a>
<div class="section-atitle"><table width="100%"><tr><td bgcolor="#dedeff"><h3><font color="black">29.1 Compiling and linking with a library</font>
</h3></td></tr></table>
</div><div class="section">
<a name="g29279" class="mark"></a>From the user standpoint, using a library can be made two ways:<br/><br/><ul class="itemize" id='itemize29305'
><li>Using the Bigloo <code id='code29284'
>-library <code id='code29283'
><em id='it29282'
>lib-name</em></code></code> option where 
<code id='code29286'
><em id='it29285'
>lib-name</em></code> is the name of the Bigloo library (not the name of one 
of the Unix files implementing the library). The name of the library
must be <em id='emph29287'
>lower case</em>. For instance:<br/><br/><center id='center29291'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ccffcc"><pre class="prog" id='prog29289'
>$ bigloo foo.scm -library bformat
</pre>
</td></tr>
</tbody></table></center>

</li>
<li>Using the module clause <code id='code29293'
>library</code>. This second solution avoids
using a special compilation option. For instance, this module will
automatically compile and link with the <code id='code29294'
>bformat</code> library:<br/><br/><center id='center29303'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ffffcc"><pre class="prog" id='prog29301'
>(<font color="#1919af"><strong id='bold36762'
>module</strong></font> <font color="#1919af"><strong id='bold36764'
>foo</strong></font>
   (<font color="#1919af"><strong id='bold36766'
>library</strong></font> <font color="#1919af"><strong id='bold36768'
>bformat</strong></font>))<br/><br/>...
(format ...)
</pre>
</td></tr>
</tbody></table></center>
</li>
</ul>
When a Bigloo library <code id='code29308'
><code id='code29307'
><em id='it29306'
>lib</em></code></code> is used, Bigloo automatically
searches for a file called <code id='code29311'
><code id='code29310'
><em id='it29309'
>lib</em></code>.init</code> (the &quot;init file&quot;).
If such a file exits, it is loaded at <em id='emph29312'
>compile-time</em>. For instance, the init file
may be used to specify compilation flags or to define macros used by
the compiler. The initialization file may affect any of the global
parameters of the Bigloo compiler.  For instance, a Bigloo library
supporting SSL connections would likely need a native
library. Setting the compiler variable <code id='code29313'
>*ld-post-options*</code> has
this effect. For instance, one may define an initialization file such
as:<br/><br/><center id='center29319'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ffffcc"><pre class="prog" id='prog29317'
>(cond-expand
   (bigloo-compile
    (<strong id='bold36770'
>set!</strong> *ld-post-options* (string-append <font color="red">&quot;-lssl &quot;</font> *ld-post-options*)))
   (bigloo-eval
    #unspecified))
</pre>
</td></tr>
</tbody></table></center>

When a Bigloo library <code id='code29320'
>lib</code> is used, the Bigloo linker
automatically looks at a library to be linked against the
application. The name of the file containing the library depends on
the operating system and the back-end used. For instance, under Unix,
for a library called <em id='emph29321'
>NAME</em>, the Bigloo linker searches for a
file called <code id='code29324'
>lib<em id='emph29322'
>NAME</em>_[s|u]-<em id='emph29323'
>VERSION</em>.a</code> or
<code id='code29328'
>lib<em id='emph29325'
>NAME</em>_[s|u]-<em id='emph29326'
>VERSION</em>.<em id='emph29327'
>DYNLIB-SUFFIX</em></code> in the
compilation linker path when using the native back-end. It searches
for a file <code id='code29331'
><em id='emph29329'
>NAME</em>_[s|u]-<em id='emph29330'
>VERSION</em>.zip</code> when the JVM
back-end is used.<br/><br/>This default <em id='emph29333'
>NAME</em> can be overridden in the initialization
file. The function <code id='code29334'
>declare-library!</code> associates a
Bigloo library name and a system name. <br/><br/><table cellspacing="0" class="frame" cellpadding="10" border="1" width="100%"><tbody>
<tr><td><a name="g29337" class="mark"></a><a name="declare-library!" class="mark"></a><table width="100%" style="border-collapse: collapse;" frame="void" rules="none"><tbody>
<tr><td id="tc29341" align="left" colspan="1"><strong id='bold29339'
>declare-library!</strong><em id='it29340'
> ident [attributes]</em></td><td id="tc29342" align="right" colspan="1">library procedure</td></tr>
</tbody></table>
All the attributes are optional.<br/><br/><ul class="itemize" id='itemize29378'
><li><code id='code29346'
>version:</code> the version number of the library. This defaults
to the Bigloo version number.
</li>
<li><code id='code29348'
>basename:</code> the base of the filename containing the library.
This defaults to the library name.
</li>
<li><code id='code29350'
>srfi:</code> a list of symbols denoting the SRFI 0 features implemented
 by this library. Registered SRFIs may be tested by the <code id='code29351'
>cond-expand</code> 
 form (see <a href="bigloo-32.html#SRFIs" class="inbound">SRFIs</a>). This defaults to an empty list.
</li>
<li><code id='code29353'
>dlopen-init:</code> a function to be invoked when the library is 
 dynamically loaded using the function <code id='code29354'
>dynamic-load</code>. This defaults
to <code id='code29355'
>#f</code>.
</li>
<li><code id='code29357'
>module-init:</code> a module to be initialized when the library is
 loaded. This defaults to <code id='code29358'
>#f</code>.
</li>
<li><code id='code29360'
>eval-init:</code> a module to be initialized for binding the library
 exports in the interpreter. This defaults to <code id='code29361'
>#f</code>.
</li>
<li><code id='code29363'
>class-init:</code> the JVM or .NET class name containing the module
 to be initialized. This defaults to <code id='code29364'
>#f</code>.
</li>
<li><code id='code29366'
>eval-init:</code> the JVM or .NET class name containing the module
 to be initialized for eval. This defaults to <code id='code29367'
>#f</code>.
</li>
<li><code id='code29369'
>init:</code> a function to be invoked when a library is loaded.
 This defaults to <code id='code29370'
>#f</code>.
</li>
<li><code id='code29372'
>eval:</code> a function to be invoked when a library is loaded by
 the interpreter. This defaults to <code id='code29373'
>#f</code>.
</li>
<li><code id='code29375'
>eval:</code> a function to be invoked when a library is loaded by
 the interpreter. This defaults to <code id='code29376'
>#f</code>.
</li>
</ul>
Examples:<br/><br/><ul class="itemize" id='itemize29416'
><li>The following declares a library named <code id='code29380'
>foo</code>. When loaded,
the Bigloo runtime system will seek file named <code id='code29381'
>libfoo_s-3.4a.so</code>, 
<code id='code29382'
>libfoo_u-3.4a.so</code>, <code id='code29383'
>libfoo_es-3.4a.so</code>, and <code id='code29384'
>libfoo_eu-3.4a.so</code>.
<center id='center29387'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ffffcc"><pre class="prog" id='prog29385'
>(declare-library! 'foo) 
</pre>
</td></tr>
</tbody></table></center>

</li>
<li>The following declares a library named <code id='code29389'
>pthread</code>. When loaded,
the Bigloo runtime system will seek a file named
<code id='code29390'
>libbigloopth_s-1.1a.so</code>, <code id='code29391'
>libbigloopth_u-1.1a.so</code>,
<code id='code29392'
>libbigloopth_es-1.1a.so</code>, <code id='code29393'
>libbigloopth_eu-1.1a.so</code>. Once
the library loaded, the SRFI-0 features <code id='code29394'
>pthread</code> and
<code id='code29395'
>srfi-18</code> will be bound. When loading the library, the two
modules <code id='code29396'
>__pth_thread</code> and <code id='code29397'
>__pth_makelib</code> will be
initialized. In the JVM version these modules are compiled in the
classes <code id='code29398'
>&quot;bigloo.pthread.pthread&quot;</code> and
<code id='code29399'
>&quot;bigloo.pthread.make_lib&quot;</code>.<br/><br/><center id='center29414'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ffffcc"><pre class="prog" id='prog29412'
>(declare-library! 'pthread 
                  <strong id='bold36772'
>:basename</strong> <font color="red">&quot;bigloopth&quot;</font> 
                  <strong id='bold36775'
>:version</strong> <font color="red">&quot;1.1a&quot;</font>
                  <strong id='bold36778'
>:srfi</strong> '(pthread srfi-18)
                  <strong id='bold36780'
>:module-init</strong> '__pth_thread
                  <strong id='bold36782'
>:module-eval</strong> '__pth_makelib
                  <strong id='bold36784'
>:class-init</strong> <font color="red">&quot;bigloo.pthread.pthread&quot;</font>
		  <strong id='bold36787'
>:class-eval</strong> <font color="red">&quot;bigloo.pthread.make_lib&quot;</font>)
</pre>
</td></tr>
</tbody></table></center>

</li>
</ul>
</td></tr>
</tbody></table><br/><br/><br/><table cellspacing="0" class="frame" cellpadding="10" border="1" width="100%"><tbody>
<tr><td><a name="g29421" class="mark"></a><a name="library-translation-table-add!" class="mark"></a><table width="100%" style="border-collapse: collapse;" frame="void" rules="none"><tbody>
<tr><td id="tc29425" align="left" colspan="1"><strong id='bold29423'
>library-translation-table-add!</strong><em id='it29424'
> ident name</em></td><td id="tc29426" align="right" colspan="1">library procedure</td></tr>
</tbody></table>
<table width="100%" style="border-collapse: collapse;" frame="void" rules="none"><tbody>
<tr><td id="tc29431" align="left" colspan="1"><strong id='bold29429'
>library-translation-table-add!</strong><em id='it29430'
> ident name version</em></td><td id="tc29432" align="right" colspan="1">library procedure</td></tr>
</tbody></table>
<table width="100%" style="border-collapse: collapse;" frame="void" rules="none"><tbody>
<tr><td id="tc29437" align="left" colspan="1"><strong id='bold29435'
>library-translation-table-add!</strong><em id='it29436'
> ident name version :dlopen-init initsym</em></td><td id="tc29438" align="right" colspan="1">library procedure</td></tr>
</tbody></table>

The function <code id='code29441'
>library-translation-table-add!</code> is obsolete. It should
no longer be used in new code. It is totally subsumed by
<code id='code29442'
>declare-library!</code>. The function <code id='code29443'
>library-translation-table-add!</code>
is still documented for enabling readers to understand old Bigloo source
code.<br/><br/>This function registers a <code id='code29446'
><em id='it29445'
>name</em></code> for the library <code id='code29448'
><em id='it29447'
>id</em></code>. An optional
<code id='code29450'
><em id='it29449'
>version</em></code> can be specified. The optional named argument <code id='code29451'
>dlopen-init</code>
gives the base name of the initialization entry point of a library.<br/><br/>Imagine that we would like to name our <code id='code29453'
>bformat</code> library
<code id='code29454'
>bigloobformat</code>. This can be achieved by adding the following
expression in the initialization file.<br/><br/><center id='center29459'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ffffcc"><pre class="prog" id='prog29457'
>(library-translation-table-add! 'bformat <font color="red">&quot;bigloobformat&quot;</font>)
</pre>
</td></tr>
</tbody></table></center>

Using this translation, on a Unix platform, the library used during
the linking will be named:
<code id='code29460'
>libbigloobformat_s-&lt;BIGLOO-VERSION&gt;.a</code>. In order to change the
<code id='code29461'
>&lt;BIGLOO-VERSION&gt;</code> to another suffix, such as <code id='code29462'
>1.0</code>, one may use:<br/><br/><center id='center29468'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ffffcc"><pre class="prog" id='prog29466'
>(library-translation-table-add! 'bformat <font color="red">&quot;bigloobformat&quot;</font> <font color="red">&quot;1.0&quot;</font>)
</pre>
</td></tr>
</tbody></table></center>

In such a case, the library searched will be named
<code id='code29469'
>libbigloobformat_s-1.0.a</code>.<br/><br/>Specifying a <code id='code29471'
>#f</code> prevents the insertion of any suffix. Hence,<br/><br/><center id='center29476'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ffffcc"><pre class="prog" id='prog29474'
>(library-translation-table-add! 'bformat <font color="red">&quot;bigloobformat&quot;</font> #f)
</pre>
</td></tr>
</tbody></table></center>

instructs the compiler to look at a library named
<code id='code29477'
>libbigloobformat_s.a</code>.<br/><br/></td></tr>
</tbody></table><br/>
</div><br>
<!-- Library and inline functions -->
<a name="Library-and-inline-functions"></a>
<div class="section-atitle"><table width="100%"><tr><td bgcolor="#dedeff"><h3><font color="black">29.2 Library and inline functions</font>
</h3></td></tr></table>
</div><div class="section">
<a name="g29481" class="mark"></a>
It is illegal for libraries to include inline functions that make use of
new foreign types. By &quot;new foreign type&quot;, we mean foreign types that are
defined inside the library. A library may contain inline functions but
these inline functions must not call functions using foreign types in
their prototypes. Including inline functions making use of foreign C
types will make the compiler fail when compiling user code, prompting
type errors. A library may contains non-inline
functions that make use of new foreign types.<br/><br/></div><br>
<!-- library and eval -->
<a name="library-and-eval"></a>
<div class="section-atitle"><table width="100%"><tr><td bgcolor="#dedeff"><h3><font color="black">29.3 library and eval</font>
</h3></td></tr></table>
</div><div class="section">
<a name="g29484" class="mark"></a>
The function <code id='code29486'
>library-load</code> loads a library in the interpreter.<br/><br/><table cellspacing="0" class="frame" cellpadding="10" border="1" width="100%"><tbody>
<tr><td><a name="g29489" class="mark"></a><a name="library-multithread-set!" class="mark"></a><table width="100%" style="border-collapse: collapse;" frame="void" rules="none"><tbody>
<tr><td id="tc29493" align="left" colspan="1"><strong id='bold29491'
>library-multithread-set!</strong><em id='it29492'
></em></td><td id="tc29494" align="right" colspan="1">library procedure</td></tr>
</tbody></table>
Multi-threaded and single-threaded cannot be mixed. An application must
use exclusively one kind of library. This function forces
the specie of library to load dynamically. Normally this is set automatically
and this function should be used only on exceptional situations.
</td></tr>
</tbody></table><br/>
<table cellspacing="0" class="frame" cellpadding="10" border="1" width="100%"><tbody>
<tr><td><a name="g29500" class="mark"></a><a name="library-exists?" class="mark"></a><table width="100%" style="border-collapse: collapse;" frame="void" rules="none"><tbody>
<tr><td id="tc29504" align="left" colspan="1"><strong id='bold29502'
>library-exists?</strong><em id='it29503'
> ident . path</em></td><td id="tc29505" align="right" colspan="1">library procedure</td></tr>
</tbody></table>
Checks if the library <code id='code29509'
><em id='it29508'
>ident</em></code> exists for the current back-end.<br/><br/>The regular Bigloo library paths are scanned unless optional <code id='code29512'
><em id='it29511'
>path</em></code>s
are sent to the function.
</td></tr>
</tbody></table><br/>
<table cellspacing="0" class="frame" cellpadding="10" border="1" width="100%"><tbody>
<tr><td><a name="g29516" class="mark"></a><a name="bigloo-library-path" class="mark"></a><table width="100%" style="border-collapse: collapse;" frame="void" rules="none"><tbody>
<tr><td id="tc29520" align="left" colspan="1"><strong id='bold29518'
>bigloo-library-path</strong><em id='it29519'
></em></td><td id="tc29521" align="right" colspan="1">library procedure</td></tr>
</tbody></table>
<a name="g29525" class="mark"></a><a name="bigloo-library-path-set!" class="mark"></a><table width="100%" style="border-collapse: collapse;" frame="void" rules="none"><tbody>
<tr><td id="tc29529" align="left" colspan="1"><strong id='bold29527'
>bigloo-library-path-set!</strong><em id='it29528'
></em></td><td id="tc29530" align="right" colspan="1">library procedure</td></tr>
</tbody></table>
These functions get and set the default path (a list of strings)
for loading libraries. 
</td></tr>
</tbody></table><br/>
<table cellspacing="0" class="frame" cellpadding="10" border="1" width="100%"><tbody>
<tr><td><a name="g29536" class="mark"></a><a name="library-load" class="mark"></a><table width="100%" style="border-collapse: collapse;" frame="void" rules="none"><tbody>
<tr><td id="tc29540" align="left" colspan="1"><strong id='bold29538'
>library-load</strong><em id='it29539'
> ident . path</em></td><td id="tc29541" align="right" colspan="1">library procedure</td></tr>
</tbody></table>
Loads a library in the interpreter. In addition to dynamically loading
the library, this function tries to load the <code id='code29544'
>_es</code> version of the library if it is linked
against the safe Bigloo library version or the
<code id='code29545'
>_eu</code> version if it is linked against the unsafe
version of the Bigloo library.<br/><br/>Searches for libraries occur in the regular Bigloo library paths
unless optional <code id='code29548'
><em id='it29547'
>path</em></code>s are sent to the function.<br/><br/>This version may be used for automatically exporting bindings to the
interpreter. In general, the <code id='code29550'
>_es</code> and <code id='code29551'
>_eu</code> libraries are
simple libraries that contain only one module, the module that is used
to build the heap-file. For instance, let's consider an implementation
of a library for SSL programming. This library is composed of a single
implementation module <code id='code29552'
>__ssl_ssl</code>. The library is build using a
heap file:<br/><br/><center id='center29560'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ffffcc"><pre class="prog" id='prog29558'
>(<font color="#1919af"><strong id='bold36794'
>module</strong></font> <font color="#1919af"><strong id='bold36796'
>__ssl_makelib</strong></font>
   (<font color="#1919af"><strong id='bold36798'
>import</strong></font> <font color="#1919af"><strong id='bold36800'
>__ssl_ssl</strong></font>))
</pre>
</td></tr>
</tbody></table></center>

Changing this file for:<br/><br/><center id='center29568'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ffffcc"><pre class="prog" id='prog29566'
>(<font color="#1919af"><strong id='bold36802'
>module</strong></font> <font color="#1919af"><strong id='bold36804'
>__ssl_makelib</strong></font>
   (<font color="#1919af"><strong id='bold36806'
>import</strong></font> <font color="#1919af"><strong id='bold36808'
>__ssl_ssl</strong></font>)
   (eval   (export-all)))
</pre>
</td></tr>
</tbody></table></center>

enables the construction of the <code id='code29569'
>_es</code> and <code id='code29570'
>_eu</code> libraries.<br/><br/>When the system loads a dynamic library, it <em id='emph29572'
>initializes</em> it. 
For that it expects to find <em id='emph29573'
>initialization entry points</em> in the dynamic
libraries that are named after the library's name. More precisely, for
the <code id='code29574'
>LIB_s</code> library, the loader seeks the entry point named
<code id='code29575'
>&quot;LIB_s&quot;</code> and for the <code id='code29576'
>LIB_es</code>, it seeks <code id='code29577'
>&quot;LIB_es&quot;</code>.
The name of the initialization entry of a library can be changed using
the <code id='code29578'
>declare-library!</code> function. If that named is changed,
one module of the library must contain an <code id='code29579'
>option</code> module clause
that sets the variable <code id='code29580'
>*dlopen-init*</code> with the name of the initialization
entry point.<br/><br/>Since Bigloo 3.1a, the runtime system supports a better way for
initializing libraries. <em id='emph29582'
>Initialization</em> modules can be associated
with a library. When loaded, these modules are automatically initialized.
This new method fits harmoniously with the Bigloo initialization process
and it relieves users from any requirement to annotate the source code of the library.

For instance, if a library initialization file contains the following
declaration:<br/><br/><center id='center29587'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ffffcc"><pre class="prog" id='prog29585'
>(declare-library! 'foo <strong id='bold36810'
>:module-init</strong> 'foo)
</pre>
</td></tr>
</tbody></table></center>

Then, the library must implement the <code id='code29588'
>foo</code> module.<br/><br/><center id='center29596'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ffffcc"><pre class="prog" id='prog29594'
>(<font color="#1919af"><strong id='bold36812'
>module</strong></font> <font color="#1919af"><strong id='bold36814'
>foo</strong></font>
  (<font color="#1919af"><strong id='bold36816'
>import</strong></font> <font color="#1919af"><strong id='bold36818'
>...</strong></font>)
  ...)
</pre>
</td></tr>
</tbody></table></center>

In addition if the library binds variables, functions, or classes in the
interpreter then, an <code id='code29597'
>eval-init</code> clause must be added to the
class declaration:<br/><br/><center id='center29603'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ffffcc"><pre class="prog" id='prog29601'
>(declare-library! 'foo <strong id='bold36820'
>:module-init</strong> 'foo <strong id='bold36822'
>:eval-init</strong> 'foo-eval)
</pre>
</td></tr>
</tbody></table></center>

Then, the module <code id='code29604'
>foo-eval</code> must be implemented in the 
<code id='code29605'
>libfoo_es</code> and <code id='code29606'
>libfoo_eu</code> libraries.<br/><br/><center id='center29614'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ffffcc"><pre class="prog" id='prog29612'
>(<font color="#1919af"><strong id='bold36824'
>module</strong></font> <font color="#1919af"><strong id='bold36826'
>foo-eval</strong></font>
  (<font color="#1919af"><strong id='bold36828'
>import</strong></font> <font color="#1919af"><strong id='bold36830'
>...</strong></font>)
  (eval (export-all)))
</pre>
</td></tr>
</tbody></table></center>
</td></tr>
</tbody></table><br/>
The standard distribution contains examples of such constructions. In
particular, the multi-threading libraries <code id='code29617'
>pthread</code> and
<code id='code29618'
>fthread</code> use this facility.<br/><br/></div><br>
<!-- library and repl -->
<a name="library-and-repl"></a>
<div class="section-atitle"><table width="100%"><tr><td bgcolor="#dedeff"><h3><font color="black">29.4 library and repl</font>
</h3></td></tr></table>
</div><div class="section">
<a name="g29620" class="mark"></a>
It is possible to implement a &quot;read-eval-print-loop&quot; that is extended
with the facilities implemented inside a library. In order to make
the variables, functions, and classes of a library visible from the
interpreter, the eval <code id='code29622'
>library</code> module clause has to be used.
(see <a href="bigloo-4.html#Module-Declaration" class="inbound">Module Declaration</a>) For instance, here is a module that 
implements a &quot;repl&quot; with the <code id='code29623'
>format</code> facility available:<br/><br/><center id='center29635'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ffffcc"><pre class="prog" id='prog29633'
>(<font color="#1919af"><strong id='bold36832'
>module</strong></font> <font color="#1919af"><strong id='bold36834'
>format-repl</strong></font>
   (eval (<font color="#1919af"><strong id='bold36836'
>library</strong></font> <font color="#1919af"><strong id='bold36838'
>bformat</strong></font>))
   (<font color="#1919af"><strong id='bold36840'
>library</strong></font> <font color="#1919af"><strong id='bold36842'
>bformat</strong></font>))<br/><br/><font color="#ffa600"><em id='it36844'
>;; a dummy reference to a facility of the format library</em></font>
(<strong id='bold36846'
>let</strong> ((dummy format))
   (repl))
</pre>
</td></tr>
</tbody></table></center>
<br/><br/>Alternatively, libraries can be explicitly loaded using the 
<code id='code29637'
>library-load</code> function such as:<br/><br/><center id='center29645'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ffffcc"><pre class="prog" id='prog29643'
>(<font color="#1919af"><strong id='bold36847'
>module</strong></font> <font color="#1919af"><strong id='bold36849'
>format-repl</strong></font>)<br/><br/><font color="#ffa600"><em id='it36851'
>;; a dummy reference to a facility of the format library</em></font>
(<strong id='bold36853'
>let</strong> ((dummy format))
   (eval '(library-load 'bformat))
   (repl))
</pre>
</td></tr>
</tbody></table></center>
<br/><br/></div><br>
<!-- Building a library -->
<a name="Building-a-library"></a>
<div class="section-atitle"><table width="100%"><tr><td bgcolor="#dedeff"><h3><font color="black">29.5 Building a library</font>
</h3></td></tr></table>
</div><div class="section">
<a name="g29647" class="mark"></a>
Build Bigloo libraries require several steps that are explained in
this section. This section shows how to create <em id='emph29649'
>static</em> and
<em id='emph29650'
>dynamic</em> (or <em id='emph29651'
>shared</em>) libraries. However not that creating
a dynamic library highly dependent on the host operating system. Users
willing to create dynamic libraries on other operating systems should
use the <code id='code29652'
>api</code> directory of the Bigloo source code tree as an
example.<br/><br/><ul class="itemize" id='itemize29737'
><li>The first step is to build a <em id='emph29654'
>library heap</em>. This is achieved
 using a special compilation mode: <code id='code29655'
>-mkaddheap -mkaddlib -addheap -heap-library &lt;ident&gt;</code>. 
 That is, for your library you have to create a heap associated source file 
 that imports all the binding you want in your library. The heap source file
 must be <em id='emph29656'
>excluded</em> from the source files that will be used to build
 the host library.<br/><br/>Suppose we have a unique source file, <code id='code29658'
>bformat.scm</code> for our
library. The module clause of this source file is:<br/><br/><center id='center29674'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ffffcc"><pre class="prog" id='prog29672'
>(<font color="#1919af"><strong id='bold36854'
>module</strong></font> <font color="#1919af"><strong id='bold36856'
>__bformat</strong></font>
   (<font color="#1919af"><strong id='bold36858'
>export</strong></font> (<font color="#1919af"><strong id='bold36860'
>bformat</strong></font> fmt<font color="#00cf00"><strong id='bold36862'
>::bstring</strong></font> . args)
           bformat<strong id='bold36864'
>:version</strong>))<br/><br/>(<font color="#6959cf"><strong id='bold36866'
>define</strong></font> (<font color="#6959cf"><strong id='bold36868'
>bformat</strong></font> fmt . args)
   (<strong id='bold36870'
>apply</strong> format (string-replace fmt #\% #\~) args))<br/><br/>(<font color="#6959cf"><strong id='bold36871'
>define</strong></font> <font color="#6959cf"><strong id='bold36873'
>bformat</strong></font><strong id='bold36875'
>:version</strong> 1.0)
</pre>
</td></tr>
</tbody></table></center>

Prior to compiling the library, we have to create the heap associated file
(let's name it <code id='code29675'
>make_lib.scm</code>). This file could be:<br/><br/><center id='center29684'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ffffcc"><pre class="prog" id='prog29682'
>(<font color="#1919af"><strong id='bold36877'
>module</strong></font> <font color="#1919af"><strong id='bold36879'
>__make_lib</strong></font>
   (<font color="#1919af"><strong id='bold36881'
>import</strong></font> (<font color="#1919af"><strong id='bold36883'
>__bformat</strong></font> <font color="red">&quot;bformat.scm&quot;</font>))
   (eval (export-all)))
</pre>
</td></tr>
</tbody></table></center>

Building it is simple:<br/><br/><center id='center29688'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ccffcc"><pre class="prog" id='prog29686'
>bigloo -unsafe -safee -q -mkaddheap -mkaddlib -heap-library bformat \
     make_lib.scm -addheap bformat.heap
</pre>
</td></tr>
</tbody></table></center>

The options <code id='code29689'
>-mkaddheap</code> and <code id='code29690'
>-mkaddlib</code> tell Bigloo that it 
is compiling an heap associated file. The option <code id='code29691'
>-addheap</code> tells 
Bigloo the name of the heap file to be produced. The option 
<code id='code29692'
>-heap-library</code> instructs the compiler for the library name to be 
included inside the heap file. This name is used for checking versions 
at run-time.<br/><br/></li>
<li>The second step is to compile all the library source file. These
compilation must be done using the <code id='code29695'
>-mkaddlib</code> compilation mode. 
For example:<br/><br/><center id='center29699'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ccffcc"><pre class="prog" id='prog29697'
>bigloo -O3 -unsafe -safee -mkaddlib       \
   -cc gcc -fsharing -q -rm               \
   -unsafev bformat.scm -o bformat_u.o -c
bigloo -O3 -mkaddlib -g -cg -cc gcc       \
   -fsharing -q -rm                       \
   -unsafev bformat.scm -o bformat.o -c
</pre>
</td></tr>
</tbody></table></center>

The first compilation produces the <em id='emph29700'
>unsafe</em> version the second the 
produced the <em id='emph29701'
>debugging</em> version.<br/><br/></li>
<li>The third step is to build the host operating system libraries. There
is no portable way to do this. This operation may looks like:<br/><br/><center id='center29707'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ccffcc"><pre class="prog" id='prog29705'
>ar qcv libbigloobformat_s-1.0.a bformat.o
ranlib libbigloobformat_s-1.0.a
ld -G -o libbigloobformat_s-1.0.so bformat.o -lm -lc
ar qcv libbigloobformat_u-1.0.a bformat_u.o
ranlib libbigloobformat_u-1.0.a
ld -G -o libbigloobformat_u-1.0.so bformat_u.o -lm -lc
</pre>
</td></tr>
</tbody></table></center>

</li>
<li>The fourth step consist in creating the <code id='code29709'
>bformat_es</code> and 
<code id='code29710'
>bformat_eu</code> libraries
for eval. For the unsafe version we use:<br/><br/><center id='center29714'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ccffcc"><pre class="prog" id='prog29712'
>bigloo -O3 -unsafe -safee -mkaddlib       \
   -cc gcc -fsharing -q -rm               \
   -unsafev make_lib.scm -o make_lib.o -c
ld -G -o libbigloobformat_eu-1.0.so make_lib.o -lm -lc
ar qcv libbigloobformat_eu-1.0.a make_lib.o
ranlib libbigloobformat_eu-1.0.a
</pre>
</td></tr>
</tbody></table></center>

For the safe version we do:<br/><br/><center id='center29718'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ccffcc"><pre class="prog" id='prog29716'
>bigloo -O3 -mkaddlib              \
   -cc gcc -fsharing -q -rm               \
   -unsafev make_lib.scm -o make_lib.o -c
ld -G -o libbigloobformat_es-1.0.so make_lib.o -lm -lc
ar qcv libbigloobformat_es-1.0.a make_lib.o
ranlib libbigloobformat_es-1.0.a
</pre>
</td></tr>
</tbody></table></center>
<br/><br/></li>
<li>The last step is to create an initialization file <code id='code29721'
>bformat.init</code>:

<center id='center29735'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ffffcc"><pre class="prog" id='prog29733'
>(declare-library! 'bformat 
   <strong id='bold36886'
>:version</strong> <font color="red">&quot;1.0&quot;</font>
   <strong id='bold36889'
>:srfi</strong> '(bformat)
   <strong id='bold36891'
>:basename</strong> <font color="red">&quot;bigloobformat&quot;</font>
   <strong id='bold36894'
>:module-init</strong> '__bformat
   <strong id='bold36896'
>:module-eval</strong> '__make_lib
   <strong id='bold36898'
>:class-init</strong> <font color="red">&quot;bigloo.bformat.__bformat&quot;</font>
   <strong id='bold36901'
>:class-eval</strong> <font color="red">&quot;bigloo.bformat.__make_lib&quot;</font>)
</pre>
</td></tr>
</tbody></table></center>

</li>
</ul>
At this time, you are ready to use your library. For that, let's assume
the file <code id='code29738'
>foo.scm</code>:<br/><br/><center id='center29749'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ffffcc"><pre class="prog" id='prog29747'
>(<font color="#1919af"><strong id='bold36904'
>module</strong></font> <font color="#1919af"><strong id='bold36906'
>foo</strong></font>
   (<font color="#1919af"><strong id='bold36908'
>library</strong></font> <font color="#1919af"><strong id='bold36910'
>bformat</strong></font>))<br/><br/>(bigloo-library-path-set! (cons (pwd) (bigloo-library-path)))
(print (bformat <font color="red">&quot;Library path: %a&quot;</font> (bigloo-library-path)))<br/><br/>(eval '(library-load 'bformat))
(repl)
</pre>
</td></tr>
</tbody></table></center>

It can be compiled and executed with:<br/><br/><center id='center29753'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ccffcc"><pre class="prog" id='prog29751'
>bigloo foo.scm -L . -copt -L.
LD_LIBRARY_PATH=.:$LD_LIBRARY_PATH ./a.out
</pre>
</td></tr>
</tbody></table></center>

The Bigloo distribution contains library exemplars that should probably
considered as a departure point for new libraries.<br/><br/></div><br>
<!-- Library and modules -->
<a name="Library-and-modules"></a>
<div class="section-atitle"><table width="100%"><tr><td bgcolor="#dedeff"><h3><font color="black">29.6 Library and modules</font>
</h3></td></tr></table>
</div><div class="section">
<a name="g29755" class="mark"></a>
A Bigloo library may be composed of several Bigloo modules (even if in
our example only one module was used). The modules composing the library
are free to import each other. Nevertheless, someone designing a Bigloo
library should be aware that Bigloo importation creates dependences
between modules. A module <code id='code29757'
>mod1</code> that imports a module <code id='code29758'
>mod2</code>
depends on <code id='code29759'
>mod2</code> because <code id='code29760'
>mod1</code> requires <code id='code29761'
>mod2</code> to be
initialized (i.e. <code id='code29762'
>mod1</code> calls to the initialization function of
<code id='code29763'
>mod2</code>). The result is that using <code id='code29764'
>import</code> clauses inside
modules composing a library may create a lot of dependencies between the
object files that are used to build the associated Unix
library. Dependencies should be avoided because they make the Unix
linkers unable to produce small stand-alone programs. Instead of
<code id='code29765'
>import</code> clauses, <code id='code29766'
>use</code> clauses should be
preferred. <code id='code29767'
>Use</code> clauses do not create dependencies because a
module <code id='code29768'
>mod1</code> that <code id='code29769'
>use</code>s a second module <code id='code29770'
>mod2</code> does not
require <code id='code29771'
>mod2</code> to be initialized. Of course, it may happen
situations where the initialization is mandatory and thus, the
<code id='code29772'
>import</code> must not be replaced with a <code id='code29773'
>use</code> clause. The source
code of the Bigloo library makes use of <code id='code29774'
>import</code> and <code id='code29775'
>use</code>
clauses. The Bigloo standard library should be studied as an example.<br/><br/></div><br>
<!-- Library and macros -->
<a name="Library-and-macros"></a>
<div class="section-atitle"><table width="100%"><tr><td bgcolor="#dedeff"><h3><font color="black">29.7 Library and macros</font>
</h3></td></tr></table>
</div><div class="section">
<a name="g29777" class="mark"></a>
Bigloo libraries can export macros, expanders, and syntaxes but these
must be handled carefully. Macros (these also applies to expanders and
syntaxes) exported by modules are not visible by client code. Exported
macros have to be placed inside the initialization file. For instance,
if we change the definition of <code id='code29779'
>bformat.init</code> file for:<br/><br/><center id='center29800'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ffffcc"><pre class="prog" id='prog29798'
>(declare-library! 'bformat 
   <strong id='bold36913'
>:version</strong> <font color="red">&quot;1.0&quot;</font>
   <strong id='bold36916'
>:srfi</strong> '(bformat)
   <strong id='bold36918'
>:basename</strong> <font color="red">&quot;bigloobformat&quot;</font>
   <strong id='bold36921'
>:module-init</strong> '__bformat
   <strong id='bold36923'
>:module-eval</strong> '__make_lib
   <strong id='bold36925'
>:class-init</strong> <font color="red">&quot;bigloo.bformat.__bformat&quot;</font>
   <strong id='bold36928'
>:class-eval</strong> <font color="red">&quot;bigloo.bformat.__make_lib&quot;</font>)<br/><br/>(<font color="#6959cf"><strong id='bold36931'
>define-expander</strong></font> <font color="#6959cf"><strong id='bold36933'
>BFORMAT</strong></font>
   (<strong id='bold36935'
>lambda</strong> (x e)
      (<strong id='bold36936'
>match-case</strong> x
         ((?- (? (<strong id='bold36937'
>lambda</strong> (s) (and (string? s) (not (string-index s #\%))))) . ?a
)
          `(string-append ,&#x40;(cdr x)))
         (else
          `(bformat ,&#x40;(map (<strong id='bold36938'
>lambda</strong> (x) (e x e)) (cdr x)))))
</pre>
</td></tr>
</tbody></table></center>

At compile time the macro BFORMAT will be declared. Hence, we can change
the definition of <code id='code29801'
>foo.scm</code> for:<br/><br/><center id='center29812'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ffffcc"><pre class="prog" id='prog29810'
>(<font color="#1919af"><strong id='bold36939'
>module</strong></font> <font color="#1919af"><strong id='bold36941'
>foo</strong></font>
   (<font color="#1919af"><strong id='bold36943'
>library</strong></font> <font color="#1919af"><strong id='bold36945'
>bformat</strong></font>))<br/><br/>(bigloo-library-path-set! (cons (pwd) (bigloo-library-path)))
(print (BFORMAT <font color="red">&quot;library path: %a&quot;</font> (bigloo-library-path)))<br/><br/>(eval '(library-load 'bformat))
(repl)
</pre>
</td></tr>
</tbody></table></center>

</div><br>
<!-- A complete library example -->
<a name="A-complete-library-example"></a>
<div class="section-atitle"><table width="100%"><tr><td bgcolor="#dedeff"><h3><font color="black">29.8 A complete library example</font>
</h3></td></tr></table>
</div><div class="section">
<a name="g29813" class="mark"></a>
For the means of an example let's suppose we want to design a Bigloo
library for 2d points. That library is made of three implementation
files: two C files, <code id='code29815'
>cpoint.h</code> and <code id='code29816'
>cpoint.c</code> and one Scheme
file <code id='code29817'
>spoint.scm</code>. Here are defined the three files:<br/><br/><code id='code29819'
>cpoint.h</code>:<center id='center29822'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ffffcc"><pre class="prog" id='prog29820'
>struct point_2d {
   double x, y;
};
</pre>
</td></tr>
</tbody></table></center>

<code id='code29823'
>cpoint.c</code>:<center id='center29829'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ffffcc"><pre class="prog" id='prog29827'
>#include &lt;stdio.h&gt;
#include <font color="red">&quot;cpoint.h&quot;</font><br/><br/>int print_point_2d( struct point_2d *pt ) {
   printf( <font color="red">&quot;&lt;point-2d: %g, %g&gt;&quot;</font>, pt-&gt;x, pt-&gt;y );
}
</pre>
</td></tr>
</tbody></table></center>

<code id='code29830'
>spoint.scm</code>:<center id='center29856'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ffffcc"><pre class="prog" id='prog29854'
>(<font color="#1919af"><strong id='bold36950'
>module</strong></font> <font color="#1919af"><strong id='bold36952'
>__point</strong></font>
   (include <font color="red">&quot;spoint.sch&quot;</font>)
   (<strong id='bold36955'
>extern</strong>  (include <font color="red">&quot;cpoint.h&quot;</font>))
   (<font color="#1919af"><strong id='bold36957'
>export</strong></font>  (<font color="#1919af"><strong id='bold36959'
>make-point</strong></font><font color="#00cf00"><strong id='bold36961'
>::s-point_2d*</strong></font> <font color="#00cf00"><strong id='bold36963'
>::double</strong></font> <font color="#00cf00"><strong id='bold36965'
>::double</strong></font>)
            (print-point <font color="#00cf00"><strong id='bold36967'
>::s-point_2d*</strong></font>)
            (point? <font color="#00cf00"><strong id='bold36969'
>::obj</strong></font>)))<br/><br/>(<font color="#6959cf"><strong id='bold36971'
>define</strong></font> (<font color="#6959cf"><strong id='bold36973'
>make-point</strong></font><font color="#00cf00"><strong id='bold36975'
>::s-point_2d*</strong></font> x<font color="#00cf00"><strong id='bold36977'
>::double</strong></font> y<font color="#00cf00"><strong id='bold36979'
>::double</strong></font>)
   (s-point_2d* x y))<br/><br/>(<font color="#6959cf"><strong id='bold36981'
>define</strong></font> (<font color="#6959cf"><strong id='bold36983'
>print-point</strong></font> p<font color="#00cf00"><strong id='bold36985'
>::s-point_2d*</strong></font>)
   (print_point_2d p))<br/><br/>(<font color="#6959cf"><strong id='bold36987'
>define</strong></font> (<font color="#6959cf"><strong id='bold36989'
>point?</strong></font> obj<font color="#00cf00"><strong id='bold36991'
>::obj</strong></font>)
   (s-point_2d*? obj)
   obj)
</pre>
</td></tr>
</tbody></table></center>

<code id='code29857'
>makelib.scm</code>:
We want our library to be composed of the whole exported Scheme
functions. Thus the file to build the heap library could look like:<br/><br/><center id='center29865'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ffffcc"><pre class="prog" id='prog29863'
>(<font color="#1919af"><strong id='bold36993'
>module</strong></font> <font color="#1919af"><strong id='bold36995'
>__point_makelib</strong></font>
   (<font color="#1919af"><strong id='bold36997'
>import</strong></font> <font color="#1919af"><strong id='bold36999'
>__point</strong></font>)
   (eval (export-all)))
</pre>
</td></tr>
</tbody></table></center>
<br/><br/><code id='code29867'
>point.init</code>:Let's suppose that the <code id='code29868'
>point</code> library requires the <code id='code29869'
>libposix</code>
library. This means that any file linked with the <code id='code29870'
>point</code> library
needs to be also linked with the <code id='code29871'
>posix</code> library. Furthermore, 
programs making use of the <code id='code29872'
>point</code> library needs to include the
<code id='code29873'
>point.sch</code> file. That Scheme file needs in turn the C file 
<code id='code29874'
>point.h</code> otherwise the produced C files won't compile. The need
for the <code id='code29875'
>libposix</code> library and for the <code id='code29876'
>point.h</code> file may be
specified inside the <code id='code29877'
>point.init</code> file. For our current library,
the <code id='code29878'
>point.init</code> file could look like:<br/><br/><center id='center29896'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ffffcc"><pre class="prog" id='prog29894'
>(declare-library! 'point 
                  <strong id='bold37001'
>:basename</strong> <font color="red">&quot;point&quot;</font> 
                  <strong id='bold37004'
>:srfi</strong> '(point)
                  <strong id='bold37006'
>:eval-init</strong> '__point_makelib)<br/><br/>(<strong id='bold37008'
>set!</strong> *ld-options*
      (string-append <font color="red">&quot;-L/usr/lib &quot;</font> *ld-options*))<br/><br/>(<strong id='bold37010'
>set!</strong> *bigloo-user-lib*
      (cons <font color="red">&quot;-lm&quot;</font> *bigloo-user-lib*))<br/><br/>(<strong id='bold37012'
>set!</strong> *additional-include-foreign*
      (cons <font color="red">&quot;cpoint.h&quot;</font> *additional-include-foreign*))
      
(<font color="#6959cf"><strong id='bold37014'
>define-macro</strong></font> (<font color="#6959cf"><strong id='bold37016'
>point</strong></font> x y)
   `(make-point ,x ,y))
</pre>
</td></tr>
</tbody></table></center>

This file updates some compilation variables (<code id='code29897'
>*ld-options*</code>,
<code id='code29898'
>*bigloo-user-lib*</code>, <code id='code29899'
>*additional-include-foreign*</code>) and
defines a macro: <code id='code29900'
>point</code>. Because the <code id='code29901'
>point.init</code> file will
be loaded each time a compilation require the <code id='code29902'
>point</code> library is
spawned, user code are allowed to use the <code id='code29903'
>point</code> macro. Here is an
example file making use of the <code id='code29904'
>point</code> library:<br/><br/><code id='code29906'
>example.scm</code><center id='center29916'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ffffcc"><pre class="prog" id='prog29914'
>(<font color="#1919af"><strong id='bold37018'
>module</strong></font> <font color="#1919af"><strong id='bold37020'
>example</strong></font>)<br/><br/>(<strong id='bold37022'
>let</strong> ((p (point 2.9 3.5)))
   (print <font color="red">&quot;point?: &quot;</font> (point? p))
   (print <font color="red">&quot;point?: &quot;</font> (point? 4))
   (print-point p)
   (print <font color="red">&quot;done...&quot;</font>))
</pre>
</td></tr>
</tbody></table></center>

To conclude that example here is the <code id='code29917'
>Makefile</code> used to compile
the <code id='code29918'
>point</code> library, heap file and one example.<br/><br/><center id='center29939'
><table cellspacing="0" class="color" cellpadding="0" width="95%"><tbody>
<tr><td bgcolor="#ccffcc"><pre class="prog" id='prog29937'
># bigloo flags
BIGLOO          = bigloo
RELEASE		= `$(BIGLOO) -eval '(begin (print *bigloo-version*) (exit 0))'`
BHEAPFLAGS      = -unsafe -q -mkaddheap -mkaddlib -v2 -heap-library point
BCOMMONFLAGGS   = -mkaddlib -fsharing -q $(VERBOSE)        \
                  -copt '$(CCOMMONFLAGS)' -cc $(CC)
BSAFEFLAGS      = $(BCOMMONFLAGGS) -cg -O3 -g -cg -unsafev \
                  -eval '(set! *indent* 4)' -rm
BUNSAFEFLAGS    = $(BCOMMONFLAGS) -O4 -unsafe<br/><br/># cigloo flags
CIGLOO          = cigloo<br/><br/># cflags
CC              = gcc
CCOMMONFLAGS    = -I.
CSAFEFLAGS      = $(CCOMMONFLAGS)
CUNSAFEFLAGS    = $(CCOMMONFLAGS) -O2<br/><br/># library objects
SAFE_OBJECT     = olib/spoint.o olib/cpoint.o
UNSAFE_OBJECT   = olib_u/spoint.o olib_u/cpoint.o<br/><br/>all: .afile heap lib example<br/><br/>.afile: spoint.scm makelib.scm
	bglafile $^ &gt; $&#x40;<br/><br/>heap: point.heap<br/><br/>point.heap: spoint.sch spoint.scm
	$(BIGLOO) $(BHEAPFLAGS) makelib.scm -addheap point.heap<br/><br/>lib: lib_u lib.a<br/><br/>lib.a: olib $(SAFE_OBJECT)
	ar qcv libpoint_s-$(RELEASE).a $(SAFE_OBJECT) <br/><br/>lib_u: olib_u $(UNSAFE_OBJECT)
	ar qcv libpoint_u-$(RELEASE).a $(UNSAFE_OBJECT) <br/><br/>olib:
	mkdir olib<br/><br/>olib_u:
	mkdir olib_u<br/><br/>olib_u/spoint.o olib/spoint.o: spoint.scm
	$(BIGLOO) $(BSAFEFLAGS) $(&lt;F) -o $*.o -c<br/><br/>olib_u/cpoint.o olib/cpoint.o: cpoint.c
	$(CC) $(CSAFEFLAGS) $(&lt;F) -o $*.o -c<br/><br/>spoint.sch: cpoint.h cpoint.c
	cigloo $^ &gt; $&#x40;<br/><br/>example: heap lib
	$(BIGLOO) -v2 -L . -library point \
            -static-bigloo example.scm -o example<br/><br/>clean:
	-/bin/rm -f point.heap
	-/bin/rm -f spoint.sch spoint.c
	-/bin/rm -fr olib olib_u
	-/bin/rm -f example example.c example.o
	-/bin/rm -f libpoint_s-$(RELEASE).a libpoint_u-$(RELEASE).a
</pre>
</td></tr>
</tbody></table></center>
<br/><br/><br/><br/>

</div><br>
</div></td>
</tr></table><div class="skribe-ending">
<hr> 
<p class="ending" id='paragraph37031'
><font size="-1">
This <span class="sc">Html</span> page has been produced by 
<a href="http://www-sop.inria.fr/indes/fp/Skribe" class="http">Skribe</a>.
<br/>
Last update <em id='it37029'
>Thu Nov 19 07:13:49 2020</em>.</font></p></div>
</body>
</html>